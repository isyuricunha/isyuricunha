name: Auto Tag

on:
  # Runs on pushes targeting the default branch
  push:
    branches: ["main"]

jobs:
  tag:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Get latest tag
        id: latest_tag
        run: |
          latest_tag=$(git describe --tags --abbrev=0)
          if [ -z "$latest_tag" ]; then
            echo "No tags found, creating initial tag"
            latest_tag="v0.1.0" # Set initial tag if none found
          fi
          echo "Latest tag: $latest_tag"
          echo "LATEST_TAG=$latest_tag" >> $GITHUB_ENV

      - name: Create tag
        id: create_tag
        run: |
          # Extract version components
          IFS='.' read -r major minor patch <<< "${{ steps.latest_tag.outputs.LATEST_TAG }}"
          # Increment the patch version
          patch=$((patch + 1))
          new_tag="v$major.$minor.$patch"
          echo "New tag: $new_tag"
          echo "NEW_TAG=$new_tag" >> $GITHUB_ENV

      - name: Push tag
        run: |
          git config user.email "${GITHUB_ACTOR}@users.noreply.github.com"
          git config user.name "${GITHUB_ACTOR}"
          git tag ${{ steps.create_tag.outputs.NEW_TAG }}
          git push origin ${{ steps.create_tag.outputs.NEW_TAG }}
