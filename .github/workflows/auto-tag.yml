name: Auto Tag

on:
  # Runs on pushes targeting the default branch
  push:
    branches: ["main"]

jobs:
  tag:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Get latest tag
        id: get_tag
        run: |
          LAST_TAG=$(git describe --tags --abbrev=0)
          echo "LAST_TAG=${LAST_TAG}" >> $GITHUB_ENV

      - name: Create new tag
        id: create_tag
        run: |
          # Extract major, minor, and patch versions from the last tag
          IFS='.' read -r -a VERSION_PARTS <<< "${LAST_TAG//v/}"
          MAJOR=${VERSION_PARTS[0]}
          MINOR=${VERSION_PARTS[1]}
          PATCH=${VERSION_PARTS[2]}

          # Increment the patch version
          PATCH=$((PATCH + 1))

          # Create new tag
          NEW_TAG="v${MAJOR}.${MINOR}.${PATCH}"
          echo "NEW_TAG=${NEW_TAG}" >> $GITHUB_ENV

      - name: Push tag
        run: |
          git config user.email "${GITHUB_ACTOR}@users.noreply.github.com"
          git config user.name "${GITHUB_ACTOR}"
          git tag $NEW_TAG
          git push origin $NEW_TAG
