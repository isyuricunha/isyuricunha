name: auto tag/release

on:
  push:
    branches:
      - master
    tags: "1.*"
permissions:
  contents: write
jobs:
  build:
    name: Build
    runs-on: ubuntu-latest
    steps:
      - name: Release
        uses: "marvinpinto/action-automatic-releases@latest"
        with:
          repo_token: "${{ secrets.GITHUB_TOKEN }}"
          prerelease: false
          files: |
                  *.*
      - name: "Generate Changelog and Release"
        id: release
        uses: marvinpinto/action-automatic-releases@latest
        with:
          repo_token: ${{ secrets.GITHUB_TOKEN }}
          prerelease: false
          automatic_release_tag: ${{ steps.increment-tag.outputs.new_tag }}
          title: "Development Build"
          files: |
            *.*

      - name: "Generate and Upload Changelog"
        if: steps.release.outputs.automatic_releases_tag != ''
        run: |
          # Gerar changelog a partir dos commits
          changelog=$(git log --pretty=format:"- %s (%h)" $(git describe --abbrev=0 --tags $(git describe --abbrev=0 --tags --abbrev=0..HEAD))..HEAD)

          # Atualizar notas de lan√ßamento
          curl -X PATCH \
            -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            -H "Accept: application/vnd.github.v3+json" \
            https://api.github.com/repos/${{ github.repository }}/releases/${{ steps.release.outputs.automatic_releases_tag }} \
            -d '{"body": "'"$changelog"'"}'
